<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Manhattan's Tiny Parcels</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">


  <link rel="stylesheet" href="./leaflet.css" />
  <style>

    #map {
      width:60%;
      height: 100vh;
      float:left;
    }

    #readme {
      width: 40%;
      height: 100vh;
      float: right;
      overflow: scroll; 
      overflow-x:hidden;
    }

    .markdown-body {
      padding: 5px;
    }

    body, html {
      background:#ffffff;
      height:100%;
      padding: 0;
      margin: 0;
    }

    path {
      stroke: rgb(7, 130, 34);
      stroke-width: 8px;
      fill: #7296FF;
      fill-opacity: .8;
      stroke-opacity: 1;
    }

    .address {
      font-weight: bold;
      font-size: 14px;
    }

  </style>
  <link rel="stylesheet" href="style/github-markdown.css"/>
</head>

<body>
  <div id = 'map'>
  </div>
  <div id = 'readme'>
    <div id = 'putTheMarkdownHere' class="markdown-body">
    </div>
  </div>

  <script src="js/marked.min.js"></script>
  <script src="./leaflet.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script>
  //This map contains parcels that are under 100 sf in Manhattan according to 2014 Pluto Data


  var map = L.map('map',{

  }).setView([40.733055, -74.003155], 16);

    L.tileLayer('http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
      minZoom:0,
      maxZoom:22,
      maxNativeZoom:18
    }).addTo(map);


    var davidServer = "http://data.getnycinfo.com";

    var bromley = L.tileLayer.wms(davidServer+"/geoserver/tiger/wms",
      {service: 'WMS',
       version: '1.1.0',
       format: 'image/png',
       //request: 'GetMap',
       transparent: 'true',
       tiled: 'true',
       layers: 'tiger:transparent_geo_map'});

    bromley.addTo(map);

    function computeBoxRadius(zoomLevel) {
      if (zoomLevel <= 16) return 40; 
      if (zoomLevel === 17) return 70;
      if (zoomLevel === 18) return 120;
      if (zoomLevel >= 19) return 160;
    }


    var xOffset = 0;
    var yOffset = 0;

    map.on('movestart', function(e) {
      //console.log("move start at "+e.target.dragging._lastPos.x+","+e.target.dragging._lastPos.y);
    });
    map.on('move', function(e) {
      //console.log("move start at "+e.target.dragging._lastPos.x+","+e.target.dragging._lastPos.y);
      if (e.target.dragging._lastPos != null) {
        xOffset = -(e.target.dragging._lastPos.x);
        yOffset = -(e.target.dragging._lastPos.y);
      }
    });
    map.on('moveend', function(e) {
      //console.log("move end at "+e.target.dragging._lastPos.x+","+e.target.dragging._lastPos.y);
    });

    var bromParent = bromley._container;
    $("#map").mousemove(function(e) {
      var xcoord = e.clientX;
      var ycoord = e.clientY;

      var squareRadius = computeBoxRadius(map.getZoom());
      bromParent.style.clip = 'rect('+(yOffset+ycoord-squareRadius)+'px ' 
                                     +(xOffset+xcoord+squareRadius) + 'px '
                                     +(yOffset+ycoord+squareRadius)+'px '
                                     +(xOffset+xcoord-squareRadius)+'px)';

      console.log("clip is: "+bromParent.style.clip);
    });
    

    //load polygons from postgis
    var geojsonurl = davidServer+"/geoserver/tiger/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=tiger:small%20parcels&maxFeatures=90&outputFormat=application/json";
    $.ajax({
      dataType: "json",
      url: geojsonurl,
      success: function(data) {
	var myLayer = L.geoJson(data);
	map.addLayer(myLayer);
      },
      error: function (xhr, ajaxOptions, thrownError) {
	console.log(xhr.status);
	console.log(thrownError);
      }
    });


      function onEachFeature(feature, layer) {
        layer.bindPopup(
          "<span class = 'address'>"
          + feature.properties.address
          + '</span><br/>Owner: '
          + feature.properties.ownername
          + '<br/>BBL: '
          + feature.properties.bbl
          + '<br/>Area: '
          + (Math.round(feature.properties.shape_area * 10) / 10)
          + ' sq.ft.'
          );
      }


    //load points
    var centroidsurl = davidServer+"/geoserver/tiger/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=tiger:small%20parcel%20centroids&maxFeatures=90&outputFormat=application/json";
    $.ajax({
      dataType: "json",
      url: centroidsurl,
      success: function(data) {
        L.geoJson(data.features, {
          style: function(feature) {
          },
          onEachFeature: onEachFeature
        }).addTo(map);
      }
    }).error(function() {});

    //load readme Markdown
    $.ajax({
      dataType: "text",
      url: "README.md",
      success: function(data) {
        $('#putTheMarkdownHere').html(marked(data));
      },
      error: function (xhr, ajaxOptions, thrownError) {
	console.log(xhr.status);
	console.log(thrownError);
      }
    });


  </script>
</body>
</html>
